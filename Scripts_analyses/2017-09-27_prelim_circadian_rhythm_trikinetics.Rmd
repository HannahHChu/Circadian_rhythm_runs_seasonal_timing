---
title: "Preliminary trikinetics"
output: html_document
---


### Load libraries
```{r library}
library(ggplot2)
library(plyr)
library(tidyr)
library(lubridate)
```

### read in data

```{r}
#prelim<-read.table("../Data/raw/Trikinetics/2017-09-26_27_prelim_data.txt")
#prelim<-read.table("../Data/raw/Trikinetics/2017-09-26_29_prelim_data.txt")
prelim<-read.table("../Data/raw/Trikinetics/2017-09-27_2017-10-05_prelim_data_monitor2.txt")

head(prelim)
#add header
length(names(prelim))


names(prelim)<-c(c("index","read_day","read_month","read_year","read_time","monitor_status","extra","unused1","unused2","unused3","unused4","light_status"),paste("t",seq(1,32),sep=""))

##dropping unused
prelim.drop<-prelim[-1,-8:-11]
head(prelim.drop)

##play with time data
prelim.drop$read_time<-hms(prelim.drop$read_time)
prelim.drop$hour = hour(prelim.drop$read_time) + minute(prelim.drop$read_time)/60

bins=c(paste0(rep(c(paste0(0,0:9),10:23), each=4),":", c("00",15,30,45))[-1],"24:00")

prelim.drop$bins=cut(prelim.drop$hour,breaks=seq(0,24,.25),labels=bins)
head(prelim.drop)
```



### restructure data from wide to long format    

```{r wide to long format dat}
prelim.long<-gather(prelim.drop,trik_ID,counts,t1:t32)
head(prelim.long)

dim(prelim.long)


#summarize the counts for each bin  

prelim.long<-ddply(prelim.long, .(read_day,trik_ID,bins), summarise, counts = sum(counts),light_status=mean(light_status), .drop=FALSE)
head(prelim.long)

```

### visualize behavioral patterns

```{r visualizing}
prelim.long1<-subset(prelim.long,counts>0.5)

#ggplot(prelim.long1,aes(x=read_time,y=counts,colour=factor(trik_ID)))+geom_point()
#ggplot(prelim.long1,aes(x=bins,y=counts))+geom_point()+facet_grid(trik_ID~read_day)
ggplot(prelim.long,aes(x=bins,y=counts))+geom_point()+facet_grid(trik_ID~read_day)
```


### looking at 1 example : T13   (wasp)

```{r}

t13<-subset(prelim.long,trik_ID=="t13" & read_day >26 & read_day< 31 )
str(t13)

#ggplot(t13,aes(x=bins,y=counts))+geom_point()+facet_grid(.~read_day)+stat_smooth(method="loess")

ggplot(t13,aes(x=as.numeric(bins),y=counts,colour=factor(read_day)))+geom_point()+scale_x_continuous(,breaks=seq(1,96,4),labels=seq(1,24,1))+stat_smooth()
#+geom_line()
ggplot(t13,aes(x=as.numeric(bins),y=counts,colour=factor(read_day)))+geom_point()+scale_x_continuous(,breaks=seq(1,96,4),labels=seq(1,24,1))

##fitting spline
data.frame(spline(x=as.numeric(t13$bins),y=t13$counts,n=length(t13$read_day),method="periodic"))
as.vector(spline(x=as.numeric(t13$bins),y=t13$counts,n=length(t13$read_day))[1])

fulldat<-ddply(t13,.(read_day),transform,time=as.vector(spline(x=as.numeric(bins),y=counts,n=length(read_day))[1]),splinefit=as.vector(spline(x=as.numeric(bins),y=counts,n=length(read_day),method="periodic")[2]))


##plotting splines
ggplot(fulldat,aes(x=as.numeric(bins),y=counts,colour=factor(read_day)))+geom_point()+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line(data=fulldat,aes(x=x,y=y))+facet_grid(read_day~.)

## lets measure overall activity  

sum(fulldat$counts)
sum(fulldat$y)
```

### looking at 1 example : T27   (Rhago)

```{r}
t27<-subset(prelim.long,trik_ID=="t18"& read_day ==28)
#t27<-subset(prelim.long,trik_ID=="t27")
str(t27)
#t27$bins<-as.numeric(t27$bins)
#ggplot(t27,aes(x=bins,y=counts))+geom_point()+facet_grid(.~read_day)+stat_smooth(method="loess")
ggplot(t27,aes(x=as.numeric(bins),y=counts,colour=factor(read_day)))+geom_point()+scale_x_continuous(,breaks=seq(1,96,4),labels=seq(1,24,1))+geom_line()

#ggplot(t27,aes(x=bins,y=counts))+geom_point()+facet_grid(.~read_day)+stat_smooth(method="")
```



### tirkinetics cohort list  

```{r}
n<-read.csv("../Data/Trikinetics_cohorts_eclosion.csv")
n$trik_ID<-as.numeric(n$trik_ID)
prelim.long$trik_ID<-as.numeric(substr(prelim.long$trik_ID,2,3))

full<-inner_join(prelim.long,n,by=c("trik_ID"))
head(full)
daydat<-data.frame(read_day=c(27,28,29,30,1,2,3,4),day=seq(1,8))
```

### plot by cohort   

### cohort 1 
```{r}
c1<-subset(full,trik_cohort==1 & read_day!=26 & read_day !=5)
c2<-inner_join(c1,daydat,by=c("read_day"))

ggplot(c2,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+geom_vline(xintercept=c(24,80))

ggplot(c2,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+stat_smooth()+geom_vline(xintercept=c(24,80))

## sum counts 
ddply(c2,.(trik_ID,organism,read_day),summarize,counts=sum(counts))
ddply(c2,.(trik_ID,organism),summarize,counts=sum(counts))

c3<-subset(c2,organism=="fly")
ggplot(c3,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+ylim(0,50)

c5<-subset(c2,organism=="wasp")
ggplot(c5,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+ylim(0,50)




c4<-subset(c2,trik_ID=="18" & day==1)
#c4$time<-rep(seq(0,24,.25),8)
c4$time<-seq(0,24,.25)
library(psych)

cosinor(c4$time,c4$counts)
cosinor.plot("time","counts",data=c4)

### full data

c4<-subset(c2,trik_ID=="18")
c4$time<-rep(seq(0,24,.25),8)
cosinor(c4$time,c4$counts)
cosinor.plot("time","counts",data=c4,ylim=c(0,20),xlim=c(0,24))


cos.fits<-ddply(c4,.(day),summarize,phase=cosinor(time,counts)[1],fit=cosinor(time,counts)[2],amplitude=cosinor(time,counts)[3],sd=cosinor(time,counts)[4],mean=cosinor(time,counts)[5],intercept=cosinor(time,counts)[6])
cos.fits
cos.fits.long<-gather(cos.fits,metric,measure,phase:intercept)
ggplot(cos.fits.long,aes(x=day,y=measure))+geom_line()+facet_grid(.~metric)

#write.csv(c4,"2017-10-05_trik_18_fly_8days")
ggplot(c4,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+ylim(0,50)

ggplot(c4,aes(x=as.numeric(bins),y=counts,colour=factor(day)))+geom_point()+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+ylim(0,50)
```

## creating a function for cosinor model 
```{r}
sinor<-function(data=data,amp=4.61,mean=6.58,phase=14.91,period=24,time=seq(0,24,.25)){
  y=mean +amp* cos((2*pi*time)/period+phase)
  return(y)
}

plot(c4$time,c4$counts,ylim=c(0,20))
points(seq(0,24,.25),sinor(),col="red",pch=24)

```

trying catkit package   

```{r}
library(CATkit)

CATCosinor(TimeCol=c4$time,Y=c4$counts)
CATCosinor(TimeCol=time,Y=counts,fileName=c4)
```


trying spectral density of a time serries from ar

```{r}
mo1<-ar(c(c4$time,c4$counts),method="ols")
spec.ar(mo1,method="ols")
```


### trying cts filter

```{r}
library(cts)
car(x=c4[,c("time","counts")])
```

### cohort 2   

```{r}
c21<-subset(full,trik_cohort==2 & read_day!=26 & read_day !=27 &  read_day !=5)
c22<-inner_join(c21,daydat,by=c("read_day"))

ggplot(c22,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+geom_vline(xintercept=c(24,80))

```

### cohort 3

```{r}
c31<-subset(full,trik_cohort==3 & read_day!=26 &read_day !=27 & read_day !=28 & read_day !=5)
c32<-inner_join(c31,daydat,by=c("read_day"))

ggplot(c32,aes(x=as.numeric(bins),y=counts,colour=organism))+geom_point()+facet_grid(day~trik_ID)+scale_x_continuous(,breaks=seq(0,96,4),labels=seq(0,24,1))+geom_line()+geom_vline(xintercept=c(24,80))
```


# Manipulating time    

## creating a sequence of time 

```{r}
t<-hm(c("13:16","16:12"))
time.x = hour(t) + minute(t)/60

d<-seq(time.x[1],time.x[2],length.out=154)

###for whole dataset 

x<-read.csv("../Data/2017-10-03_dataslice.csv")
#x<-read.csv("../Data/test.csv")
x$purge_time_1<-hm(x$purge_time_1)
x$purge1<-hour(x$purge_time_1) + minute(x$purge_time_1)/60

#new.x<-ddply(x,.(cohort_day,tape),transform,seq(from=min(purge1,na.rm=TRUE),to=max(purge1,na.rm=TRUE),length.out=length(purge1)))

new.length<-ddply(x[,-5],.(cohort_day,tape),transform,length=length(Ind_ID))

#new.length<-ddply(x[,-2],.(cohort_day,tape),transform,length=length(purge1))


new.x<-ddply(new.length,.(cohort_day,tape),transform,ftime=seq(from=min(purge1,na.rm=TRUE),to=max(purge1,na.rm=TRUE),length.out=mean(length)))


#new.x<-ddply(new.length,.(cohort_day,tape),summarize,min=min(purge1,na.rm=TRUE),max=max(purge1,na.rm=TRUE))
write.csv(new.x,"test1.csv")

head(new.length)
resp1<-hms(new.length$resp_time_1)
resp1_conv<-hour(resp1)+minute(resp1)/60
```


### looking at photoperiod data  

```{r}
library(geosphere)
lat<-c(40.1106,42.7325,43.3361)
lon<-c(-88.2073,-84.5555,-85.8109)
site<-c("Urbana","Lansing","Grant")
coords<-data.frame(lat,lon,site)
coords
##from Filchak et al paper; nature

##mode for apple = Aug 5, 1991 (julian day 217)
## mode for haw = sept 1, 1991 (julian day 244)
##these are all infestation dates, what is the time that adults are active? 
doy=c("1991-08-05","1991-09-01")

#daylength(coords,doy=doy)
grantlight<-data.frame(daylight=daylength(coords$lat[1],1:365),day=seq(1,365))


#plot and then add vertical lines for the mode of emergence 
ggplot(grantlight,aes(x=day,y=daylight))+geom_line()+geom_vline(xintercept=c(217,244))
ggplot(grantlight,aes(x=day,y=daylight))+geom_line()+geom_vline(xintercept=c(217,244))

#ddply(coords,.(site),summarize,daylength(lat,1:365))
```
### predictions: 

* If Rhagoletis races match their activity with day length, then flies in apple should be active over a wider range within a day than flies in haws. 

### Session

```{r}
sessionInfo()
```

